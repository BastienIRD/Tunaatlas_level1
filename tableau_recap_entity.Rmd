---
title: "Summary of the treatment for each entity of the global tuna atlas"
output: html_document
date: '2022-03-23'
params: 
  working_directory: "~/Documents/Tunaatlas_level1/jobs/20220331130831"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = TRUE,
	warning = TRUE
)
library(readtext)
library(flextable)
set_flextable_defaults(
  font.size = 30,
  font.color = "black",
  table.layout = "fixed",
  digits = NULL,
  theme_fun = "theme_box"
  )
library(dplyr)
library(stringr)
library(readr)
library(webshot)
if(require("htmltools"))
  div(flextable_html_dependency())
```

```{r results='asis'}
FitFlextableToPage <- function(ft, pgwidth = 6){
  # ft <- eval(as.symbol(ft))
    table <- flextable(ft) %>% autofit() %>% fit_to_width(30)
# test <- eval(as.symbol(paste0(substitute(ft), "list_options")))
#     test2 <- flextable(test)%>% autofit() %>% fit_to_width(30)


table %>% 
  color(~ `Difference (in % of tons)` < 0, color = "green",~ `Difference (in % of tons)`) %>% 
  color(~ `Difference (in % of tons)` >0, color = "red",~ `Difference (in % of tons)`)%>% 
  colformat_num(col_keys = c("`Difference (in % of tons)`"), digits = 2) %>% flextable_to_rmd()
# test2%>% flextable_to_rmd()

}
```


```{r}
list_dir <- list.dirs(path =paste0(params$working_directory, "/entities"), full.names = TRUE, recursive = FALSE)

```

```{r}
list <- c()
for (sub_list_dir in list_dir){
  # list_options <- read_csv(paste0(sub_list_dir,"/list_options.csv"))
  #     assign(paste0(tail(str_split(paste0(sub_list_dir),"/")[[1]],n=1), "list_options"), list_options, envir = .GlobalEnv)
    sub_list_dir_2 <- list.dirs(path =paste0(sub_list_dir,"/Markdown"), full.names = TRUE, recursive = FALSE)
    details = file.info(paste0(sub_list_dir_2,"/Markdown"))
    details = file.info(sub_list_dir_2)
    details = details[with(details, order(as.POSIXct(mtime))), ]
    sub_list_dir_2 = rownames(details)
  df <- data.frame(matrix(ncol =9 , nrow = 1))
  colnames(df) <- c(paste0(tail(str_split(paste0(sub_list_dir),"/")[[1]],n=1)), "Explanation", "Fonctions", "Options", "Sum in tons", "Sum in number of fish", "Number of lines","Difference (in % of tons)", "Difference (in % of lines)"
                    )
  tons_init <- pull(read.csv(paste0(sub_list_dir_2[1],"/sums.csv"))[1])
  lines_init <- pull(read.csv(paste0(sub_list_dir_2[1],"/sums.csv"))[3])
    for (i in sub_list_dir_2){
      sums <- read.csv(paste0(i,"/sums.csv"))
      Explanation <- readtext(paste0(i,"/explication.txt"))[2]
      Fonctions <- pull(readtext(paste0(i,"/fonctions.txt"))[2])
      if (file.exists(paste0(i,"/options.txt"))){
        Options <- pull(readtext(paste0(i,"/options.txt"))[2])} else {Options <- "Aucune"}
      step <- tail(str_split(paste0(i),"/")[[1]],n=1)
      loss_percent <- 100*((tons_init - pull(sums[1]))/tons_init)
      loss_percent_lines <- 100*((lines_init - pull(sums[3]))/lines_init)
      data_i <- cbind(step,Explanation, Fonctions, Options,
                      sums, loss_percent, loss_percent_lines)
      names(data_i) <- colnames(df)
      df <- rbind(df, data_i)
      tons_init <- pull(sums[1])
      lines_init <- pull(sums[3])

    }
  df = df[-1,]
  write_csv(df, paste0(sub_list_dir,"/table.csv"))
  assign(paste0(tail(str_split(paste0(sub_list_dir),"/")[[1]],n=1)), df, envir = .GlobalEnv)
  list <- append(list,tail(str_split(paste0(sub_list_dir),"/")[[1]],n=1))

}
```


```{r fig.height=15, fig.width=10, results='asis'}
for (i in list){
  FitFlextableToPage(eval(as.symbol(i)))
}

# lapply(list, FitFlextableToPage)
# FitFlextableToPage(global_catch_1deg_1m_ps_bb_ird_level1)
```



