---
title: "Comparison of two data sets at different levels/options of the tuna atlas"
author: "Bastien Grasset"
date: "09/02/2022"
output:
  html_document:
    toc: true
    theme: united
    number_sections: true
params: 
  init: "~/Documents/Tunaatlas_level1/data/reference_jobs/entities/global_catch_1deg_1m_ps_bb_firms_Bastien_with_step_rds__level0/Markdown/level2_test_modifying_function_new_nominal_catch/rds.rds"
  final: "~/Documents/Tunaatlas_level1/data/reference_jobs/entities/global_catch_1deg_1m_ps_bb_firms_Bastien_with_step_rds__level0/Markdown/disagreggateallin1deg/rds.rds"
  filter_species: 
  filter_source_authority:  
  filter_gear:  
  filter_fishingfleet:  
  filter_time_start:  
  filter_time_end:  
  filter_cat_geo:  
  filter_catchtype:  
  filter_schooltype:  
  titre_dataset_1: "Not disagregated"
  titre_dataset_2: "Disaggregated"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r}
library(dplyr)
library(stringr)
library(readr)
library(ggplot2)
library(shiny)
library(DBI)
library(RMySQL)
library(dbplyr)
library(RPostgreSQL)
library(odbc)
library(sf)
library(tmap)
library(leaflet)
library(tidyr)
library(DT)
library(kableExtra)
library(flextable)

set_flextable_defaults(
  font.size = 10,
  font.color = "black",
  table.layout = "fixed",
  digits = 0,
  theme_fun = "theme_box"
  )

tmap_mode("view")
```


```{r}
drv <- dbDriver("PostgreSQL")      
con <- DBI::dbConnect(drv , dbname = "tunaatlas_sandbox", host = "db-tunaatlas.d4science.org", 
                 port = 5432,
                 user = "tunaatlas_u",
                 password = "21c0551e7ed2911")



# dbExistsTable(con,"iattc_after_treatment")
# dbExistsTable(con,"/../area.area_wkt")

# summary(con)
# dbListTables(con)
query <- "SELECT code, st_area(geom), geom from area.cwp_grid"
world_sf <- st_read(con, query = query) 

shapefile.fix <- st_make_valid(world_sf)%>% filter(!st_is_empty(.)) %>% mutate(cat_geo = as.factor(case_when(st_area == 1 ~ "1_deg", st_area == 25 ~ "5_deg", TRUE ~ ">_5_deg")))
shape_without_geom  <- shapefile.fix %>% as_tibble() %>% select(-geom)
options(scipen=999)

kbl <- function(data) {
  knitr::kbl(data, booktabs = TRUE, digits = 2) %>% 
    kable_styling(latex_options =c("striped", "scale_down"))
}

```


```{r}
library(readxl)
species_group <-  read_excel("data/SPECIES_LIST_RFMO_WITH_ERRORS.xlsx") %>% janitor::clean_names() %>%  select(species_group, species_code) %>% rename(species = species_code)
colnames_to_keep <- c("fishingfleet",         "gear",                 "time_start",           "time_end",            
"geographic_identifier","schooltype",           "species",              "catchtype",           
 "unit",                 "value",                "source_authority")

```


The purpose of this markdown is to describe the loss of data from the World Tuna Atlas following the different filters. 
It describes the differences between the initial data and the final data, and is intended for users of the final data who might be tempted to use it without taking into account the various filtering specificities.

# The data compared

The analyzed data are :
- ***`r params$init` for the initial data***
- ***`r params$final` for the final data***

The filters used are:

- on species: `r params$filter_species`
- on gears: `r params$filter_gear`
- on rfmos: `r params$filter_source_authority`
- on fleets: `r params$filter_fishing_fleet`
- on initial dates: `r params$filter_time_start`
- on final dates: `r params$filter_time_end`
- on geographical categories: `r params$filter_cat_geo`
- on catch types: `r params$filter_catchtype`


```{r}
# as.character(params$init)
# as.character(params$final)
last_path = function(x){tail(str_split(x,"/")[[1]],n=1)}
last_path_reduced = function(x){gsub("georef_dataset","",last_path(x))}

fonction_filtre = function(dataframe_tot_filter) {
  if (!is.null(params$filter_species)){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  species %in% params$filter_species)
  }
    if (!is.null(params$filter_gear)){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  gear %in% params$filter_gear)
    }    
  if (!is.null(params$filter_source_authority )){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  source_authority %in% params$filter_source_authority)
  }  
  if (!is.null(params$filter_fishingfleet )){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  fishingfleet %in% params$filter_fishingfleet)
  }
    if (!is.null(params$filter_time_start )){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  time_start %in% params$filter_time_start)
    }
      if (!is.null(params$filter_time_end )){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  time_end %in% params$filter_time_end)
      }
    if (!is.null(params$filter_schooltype )){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  schooltype %in% params$filter_schooltype)
  }
    if (!is.null(params$filter_catchtype )){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  catchtype %in% params$filter_catchtype)
    }
  
  if (!is.null(params$filter_cat_geo )){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  cat_geo %in% params$filter_cat_geo)
  }
    if (!is.null(params$filter_catchtype )){
    dataframe_tot_filter <-  dataframe_tot_filter %>% filter(
  cat_geo %in% params$filter_catchtype)
    }

  # dataframe_tot_filter <- dataframe_tot_filter 
  dataframe_tot_filter <- dataframe_tot_filter%>% mutate(unit = case_when(unit %in% c("MT","t","MTNO", "Tons")~ "Tons", unit %in% c("NO", "NOMT","no", "Number of fish")~"Number of fish"))
  cl_cwp_gear_level2 <- read_csv("data/cl_cwp_gear_level2.csv", 
    col_types = cols(Identifier = col_skip(), 
        Abbreviation = col_skip(), Name_Fr = col_skip(), 
        Name_Es = col_skip(), Name_Ar = col_skip()))

dataframe_tot_filter <- dataframe_tot_filter %>% full_join(cl_cwp_gear_level2, by = c("gear" = "Code"))
  
}

  
init <- fonction_filtre(readRDS(as.character(params$init)) %>% select(all_of(colnames_to_keep))%>%
                          left_join(shape_without_geom, by = c("geographic_identifier"="code")))%>% left_join(species_group, by = c("species"))%>% distinct()

final <- fonction_filtre(readRDS(as.character(params$final))%>% select(all_of(colnames_to_keep))%>%
                            left_join(shape_without_geom, by = c("geographic_identifier"="code"))) %>% left_join(species_group, by = c("species")) %>% distinct() %>% mutate(time_start =as.character(time_start))%>% mutate(time_end =as.character(time_end))

# if(any(final$unit == "MT")) final[final$unit == "MT", ]$unit <- "Tons"
# if(any(final$unit == "NO")) final[final$unit == "NO", ]$unit <- "Number of fish"
# if(any(final$unit == "MTNO")) final[final$unit == "MTNO", ]$unit <- "Tons"
# if(any(final$unit == "NOMT")) final[final$unit == "NOMT", ]$unit <- "Number of fish"


#just_for_this one before fixing th eunit problem 
# final <- final %>% mutate(unit = "Tons")

# summary(final)
# summary(init)

# test2 <- fonction_groupement(species, init, final)

  if ((params$titre_dataset_1 == "NULL")){
    titre_1 <- last_path_reduced(as.character(params$init))
  } else {
    titre_1 <- params$titre_dataset_1
  }


  if ((params$titre_dataset_2 == "NULL")){
    titre_2 <- last_path_reduced(as.character(params$final))
  } else {
    titre_2 <- params$titre_dataset_2
  }


# palette3_info <- brewer.pal.info[brewer.pal.info$category == "qual", ]  
# palette3_all <- unlist(mapply(brewer.pal, 
#                               palette3_info$maxcolors,
#                               rownames(palette3_info)))
# set.seed(2643598)  
# # palette3 <- sample(palette3_all, nrow(unique(df_i11_map$country)), replace=TRUE)
# palette3 <- sample(palette3_all, nrow(unique(init$species)), replace=TRUE)
# names(palette3) = init$species
# palette3

```



```{r}
fonction_groupement = function(x, init, final){
  x  <-   enquo(x)
  groupement_1  <-   init %>% group_by(!!x,unit) %>% summarise(value_sum_1 = sum(value, na.rm=TRUE), number_lines1 = n()) %>%mutate(value_sum1 = ifelse(is.na(value_sum_1), 0, value_sum_1))
  groupement_2  <-   final %>% group_by(!!x,unit) %>% summarise(value_sum_2 = sum(value, na.rm=TRUE), number_lines2 = n()) %>% mutate(value_sum_2 = ifelse(is.na(value_sum_2), 0, value_sum_2))
  
  fulljoin  <-   full_join(groupement_1, groupement_2) %>% 
    mutate(Perte_pourcent = 100*((value_sum_1 - value_sum_2)/value_sum_1))%>% mutate(Dimension = colnames(groupement_1[1])) %>%
    rename("Precision" = 1) %>% mutate(Precision = as.character(Precision)) %>% mutate(value_sum_2 = ifelse(is.na(value_sum_2), 0, value_sum_2))%>% mutate(Perte_pourcent = ifelse(is.na(Perte_pourcent), 100, Perte_pourcent)) %>% mutate(perte_nb_ligne = number_lines1 - number_lines2)%>% 
    mutate(Perte_en_milliers_de_tonne = (value_sum_1 - value_sum_2)/ 10^6) %>% 
           rename(`Loss (in %)` = Perte_pourcent,`Loss in millions of tons` = Perte_en_milliers_de_tonne, 
                  `Loss in number of lines` = perte_nb_ligne) %>% mutate_if(is.numeric, list(~replace_na(., 0))) %>% select(-c(value_sum1))
}
```



```{r}
carte_init <- fonction_groupement(geographic_identifier,init, final)


Dimensions <- colnames(init)[colnames(init) != "unit" & colnames(init)!= "value"]
  # t <- init[0,] 
  t <- carte_init[0,]


for (i in Dimensions){
  temporaire <- fonction_groupement(.data[[i]],init, final)
  assign(paste0("test", i), temporaire)
  
  t <- rbind(t, temporaire)
}
  
init_t <- init %>% filter(unit == "Tons")
init_no <- init %>% filter(unit == "Number of fish")
final_t <- final %>% filter(unit == "Tons")
final_no <- final %>% filter(unit == "Number of fish")
  
      somme_init_t <- sum(init_t$value, na.rm = TRUE)
    somme_init_no <- sum(init_no$value, na.rm = TRUE)
    somme_final_t <- sum(final_t$value, na.rm = TRUE)
    somme_final_no <- sum(final_no$value, na.rm = TRUE)
    

    perte_en_tonnes <- round(somme_init_t-somme_final_t)
    perte_en_tonnes_pourcent <- round(100*(somme_init_t-somme_final_t)/somme_init_t,2)
    perte_en_nombre <- round(somme_init_no-somme_final_no)
    perte_en_nombre_pourcent <- round(100*(somme_init_no-somme_final_no)/somme_init_no,2)
    try(if (perte_en_nombre_pourcent==-Inf) {perte_en_nombre_pourcent <- -100})

  
nb_ligne_init_millions <- nrow(init)/10^6
nb_ligne_final_millions<- nrow(final)/10^6

sum_valeur_init <- sum(init$value, na.rm = TRUE)/10^6
sum_valeur_final <- sum(final$value, na.rm = TRUE)/10^6

t$Dimension <-as.character(t$Dimension)
t$Precision <-as.character(t$Precision)

strates_perdues <- t %>% filter(`Loss (in %)` == 100)
nombre_strates_perdues <- nrow(strates_perdues)
nombres_de_strates_totales <- nrow(t)
pourcentage_strates_perdues <- 100-(100*((nombres_de_strates_totales-nombre_strates_perdues)/nombres_de_strates_totales))
rm(init_no, init_t, final_no, final_t)
gc()

strates_perdues_first_10 <- strates_perdues %>%ungroup %>%  group_by(Dimension)%>% slice(1:10) %>%select(Dimension, everything())
```

# Main differences

The number of lines goes from  `r nb_ligne_init_millions` millions in `r titre_1` to `r nb_ligne_final_millions` millions in `r titre_2`, which correspond to a difference of `r round(((nb_ligne_init_millions - nb_ligne_final_millions)/nb_ligne_init_millions)*100,5)`%.

The initial dataset has a total of `r round(somme_init_t)` in tons and of `r round(somme_init_no)` in number of fish.
    
The final dataset has a total of  `r round(somme_final_t)` in tons and of `r round(somme_final_no)` in number of fish.

The loss is `r perte_en_tonnes` in tons (**`r perte_en_tonnes_pourcent`%**). The loss is `r perte_en_nombre` in number of fish (**`r perte_en_nombre_pourcent`%**).

The stratas loss between the first one and the second one are : 


(only first 10 per Dimension showed), representing `r round(pourcentage_strates_perdues)` % of the total number of stratas.

```{r}
qflextable(head(strates_perdues,10))
```


# Introduction to the two datasets 

We first present the main characteristics of each dimension for each dataset.

## Comparison of the two catch evolutions

For each dataset, we compare the catch evolution and the cumulative catch evolution both in tons and number of fish.

```{r}
captures_par_time <- testtime_start %>% mutate(Time = as.Date(Precision))%>% rename(`Captures table 1` = "value_sum_1",`Captures table 2` = "value_sum_2")%>% pivot_longer(cols = c(`Captures table 1`, `Captures table 2`), names_to = "Origin", values_to ="Captures") %>% mutate(Origin = case_when(Origin == "Captures table 1" ~ titre_1 , TRUE ~ titre_2))


ggplot(captures_par_time) +
  aes(
    x = Time,
    y = Captures,
    fill = Origin,
    colour = Origin,
    group = Origin
  ) +
  geom_line(size = 0.5) +
  scale_fill_hue(direction = 1) +
  scale_color_hue(direction = 1) +
  theme_dark() +
  theme(legend.position = "top") +
  facet_wrap(vars(unit), nrow = 2L)+
  labs(x = "Time", y = "Captures")+
  facet_grid("unit", scales = "free_y")
```

## Comparison of the evolution of the cumulative catches

```{r}
captures_par_time <- captures_par_time %>% mutate(Time = as.Date(Precision))%>% arrange(Precision) %>% group_by(unit, Origin) %>%  mutate(`Captures cumulées` = cumsum(`Captures`)) %>% distinct()

ggplot_capt_par_time = function(x){
  
  ggplot(captures_par_time %>% filter(unit==x)) +
  aes(
    x = Time,
    y = `Captures cumulées`,
    colour = Origin
  ) +
  geom_line(size = 0.5) +
  scale_color_hue(direction = 1) +
  theme_minimal() +
  facet_wrap(vars(unit)) +
  labs(x = "Time", y = "Cumulated captures")+guides(fill=guide_legend(title="Dataset"))
}

ggplot_capt_par_time("Tons")

```

```{r}
# try(ggplot_capt_par_time("Number of fish"))
```

## Comparison of the two datasets

We check the distribution of the value of each dimension in tons and number of fish for each dataset.

```{r}
library(rlang)

pie_chart_2 = function(x, init= init,final = final) {
  r <- deparse(substitute(x))
  colnames <- enquo(x)
  provisoire_i <-init %>%  group_by(!!colnames, unit)%>% summarise(value = sum(value, na.rm = TRUE)) %>% group_by(unit) %>% arrange(desc(value)) %>%   mutate(id = row_number())%>%  
    mutate(class = as.factor(ifelse(id<4,!!colnames,"Others"))) %>%
    group_by(class, unit) %>%  summarise(value = sum(value, na.rm = TRUE))%>%ungroup()%>% 
    select(unit, value, class) %>%   group_by(unit) %>% mutate(pourcentage = prop.table(value)*100)%>%
    mutate(labels = paste0(pourcentage," ",  " % "))%>% arrange(desc(class))%>%
  mutate(ypos_ligne = cumsum(pourcentage)- 0.5*pourcentage ) %>%
    distinct()
  
  provisoire_t <- final %>%  group_by(!!colnames, unit)%>% summarise(value = sum(value, na.rm = TRUE)) %>% group_by(unit) %>% arrange(desc(value)) %>%   mutate(id = row_number())%>%  
    mutate(class = as.factor(ifelse(id<4,!!colnames,"Others"))) %>%
    group_by(class, unit) %>%  summarise(value = sum(value, na.rm = TRUE))%>%ungroup()%>% 
    select(unit, value, class) %>%   group_by(unit) %>% mutate(pourcentage = prop.table(value)*100)%>%
    mutate(labels = paste0(pourcentage," ",  " % "))%>% arrange(desc(class))%>%
  mutate(ypos_ligne = cumsum(pourcentage)- 0.5*pourcentage ) %>%
    distinct()
  
ggplot_i <- ggplot(provisoire_i) +
  aes(
    x = "",
    fill = class,
    colour = class,
    group = class,
    weight = pourcentage
  ) +
  geom_bar(position = "fill") +
  scale_fill_hue(direction = 1) +
  scale_color_hue(direction = 1) +
  theme_minimal()+ coord_polar("y", start=0)+ geom_text(data = (provisoire_i %>% mutate_if(is.numeric, round)), size = 3,
                           aes( x = 1 ,y = ypos_ligne/100, label = paste0(pourcentage,"%")), color = "black")+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  labs(x = "", y="") + facet_wrap("unit")
  
ggplot_t <- ggplot(provisoire_t) +
  aes(
    x = "",
    fill = class,
    colour = class,
    group = class,
    weight = pourcentage
  ) +
  geom_bar(position = "fill") +
  scale_fill_hue(direction = 1) +
  scale_color_hue(direction = 1) +
  theme_minimal()+ coord_polar("y", start=0)+ geom_text(data = (provisoire_t %>% mutate_if(is.numeric, round)), size = 3,
                           aes( x = 1, y = ypos_ligne/100, label = paste0(pourcentage,"%")), color = "black")+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  labs(x = "", y="") + facet_wrap("unit")

title <- ggdraw() + 
  draw_label(
    paste0("Distribution in value for the dimension : ",r),
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

graph <- plot_grid(ggplot_i, ggplot_t,nrow = 2,labels = c(paste0( titre_1), paste0(titre_2)),
  label_size = 10)

plot_grid(
  title, graph,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1))+
    theme(plot.background = element_rect(color = "black"))


}


# ggplot(t)+geom_bar(mapping = aes(x = pourcentage, y = as.factor(class)))

Dimensions <- colnames(init)[colnames(init) != "unit" & colnames(init)!= "value"&
                               colnames(init)!= "time_start"&
                               colnames(init)!= "time_end"&
                               colnames(init)!= "geographic_identifier"]
  # t <- init[0,] 
```

```{r}
library(cowplot)
fishing_fleet <- pie_chart_2(fishingfleet, init, final)
source_authority <- pie_chart_2(source_authority, init, final)
cat_geo <- pie_chart_2(cat_geo, init, final)
species <- pie_chart_2(species, init, final)
species_group <- pie_chart_2(species_group, init, final)
# gear <- pie_chart_2(gear, init, final)
Name_En <- pie_chart_2(Name_En, init, final)

```

```{r}
species

cat_geo

fishing_fleet

source_authority

species_group

Name_En

# plot_grid(species, cat_geo, fishing_fleet,source_authority,species_group,  ncol = 1)
```


## Spatial coverage

```{r}
library(gdata)
fonction_empreinte_spatiale = function(variable_affichee){
  selection = function(x){x %>% ungroup() %>% select(geographic_identifier, value, cat_geo, unit)}
  Initial_dataframe <- selection(init)
  Final_dataframe <- selection(final)
  geo_data <- gdata::combine(`Initial_dataframe`, `Final_dataframe`)
  rm(`Initial_dataframe`, `Final_dataframe`)
  gc()
inner_join <- st_as_sf(geo_data%>% group_by(geographic_identifier, unit,source)  %>%  summarise(value = sum(value, na.rm = TRUE))  %>% filter(value != 0) %>% inner_join(shapefile.fix, by = c("geographic_identifier"="code")))

tm_shape(inner_join %>% filter(unit == variable_affichee))+
  tm_fill("value", palette="RdYlGn", style="cont", n=8,
				 id="name", midpoint = 0) +
  tm_layout(legend.outside = FALSE) + tm_facets(by=c("cat_geo","source"))

tm_shape(inner_join %>% filter(unit == variable_affichee))+
  tm_fill("value", palette="RdYlGn", style="cont", n=8,
				 id="name", midpoint = 0) +
  tm_layout(legend.outside = FALSE) + tm_facets(by=c("cat_geo","source"))
rm(inner_join)
}
tmap_mode("plot")

number_of_cat_geo <- nrow(unique(t$cat_geo))
cat_geo <- (unique(t$cat_geo))
```

We represent the spatial coverage, faceted by the geographical category. The geographical category depends on the area of the geographic polygon. In this case there are `r number_of_cat_geo` categories which are `r cat_geo`. The category is made on the area, also different shapes could be included in the same geographical category (example 5x10, 10x5 and 25x2).

### Spatial coverage in tons

```{r}
fonction_empreinte_spatiale("Tons")
```

### Spatial coverage in number of fish

```{r}
fonction_empreinte_spatiale("Number of fish")
```

# Loss

This section detail the different loss that observed between the dataframe `r titre_1` and `r titre_2`.

```{r}
disappearing_strates <- t %>% filter(value_sum_2 == 0)
```


```{r}
topn <- 5  
```

## The losses for each dimension

We will look for each dimension the `r topn` most important losses.

```{r paged.print=TRUE}
library(knitr)
library(DT)
library(kableExtra)
# kable(t %>%  filter(Dimension %in% c("species", "source_authority","cat_geo", "fishingfleet")) %>% mutate(Dimension = as.factor(Dimension)) %>%  group_by(unit, Dimension) %>% arrange(desc(`Loss (in %)`))   %>%   mutate(id = row_number())%>% ungroup() %>%  mutate(test = ifelse(id>(topn-1),"Others",as.character(Precision))) %>%mutate(Precision = test) %>%  mutate_if(is.character, as.factor)%>%select(-c(id, test)) %>% ungroup() %>%  group_by(Precision,unit, Dimension)%>% summarise_all(sum)  %>% group_by(unit, Dimension) %>%arrange(desc(`Loss (in %)`), desc(`Loss in millions of tons`)) %>%   group_split(unit))

valeur_totale <- sum(init$value, na.rm = TRUE)
ligne_totale <- nrow(init)

# unit_t <- t %>% filter(unit == "Tons")%>% filter(Dimension %in% c("species", "source_authority","cat_geo", "fishingfleet", "species_group")) %>% mutate(Dimension = as.factor(Dimension)) %>%  group_by( Dimension) %>% arrange(desc(`Loss (in %)`))   %>%   mutate(id = row_number())%>%   mutate(test = as.factor(ifelse(id>(topn-1),paste0("Others"),paste0(as.character(Precision))))) %>% ungroup() %>% group_by(Dimension,test) %>% summarise(across(is.numeric, sum)) %>% mutate(`Loss (in %)` = (`Loss in millions of tons`*1000000/value_sum_1)*100) %>% select(-id)%>%group_by(Dimension) %>%  arrange(Dimension,desc(`Loss (in %)`))
# 
# unit_no <- t %>% filter(unit == "Number of fish") %>% filter(Dimension %in% c("species", "source_authority","cat_geo", "fishingfleet", "species_group")) %>% mutate(Dimension = as.factor(Dimension)) %>%  group_by( Dimension) %>% arrange(desc(`Loss (in %)`))   %>%   mutate(id = row_number())%>%   mutate(test = as.factor(ifelse(id>(topn-1),paste0("Others"),paste0(as.character(Precision))))) %>% ungroup() %>% group_by(Dimension,test) %>% summarise(across(is.numeric, sum)) %>% mutate(`Loss (in %)` = (`Loss in millions of tons`*1000000/value_sum_1)*100) %>% select(-id)%>%group_by(Dimension) %>%  arrange(Dimension,desc(`Loss (in %)`))

unit <- t %>% filter(Dimension == "species" ) %>%  filter(Dimension %in% c("species", "source_authority","cat_geo", "fishingfleet", "species_group",# "gear", 
                                                                           "Name_En")) %>% mutate(Dimension = as.factor(Dimension)) %>%  group_by( Dimension, unit) %>% arrange(desc(`Loss (in %)`))   %>%   mutate(id = row_number())%>%   mutate(Precision = as.factor(ifelse(id>(topn-1),paste0("Others"),paste0(as.character(Precision))))) %>% ungroup() %>% group_by(Dimension,Precision, unit) %>% summarise(across(is.numeric, sum)) %>% mutate(`Loss (in %)` = (`Loss in millions of tons`*1000000/value_sum_1)*100) %>% select(-id, -number_lines2)%>%group_by(unit,Dimension) %>%  arrange(Dimension,desc(`Loss (in %)`))

# %>% ungroup()%>% group_by(test,Dimension) %>% mutate_all(sum) %>% ungroup() %>% mutate(`Loss (in %)` =`Loss in millions of tons`/sum(`Loss in millions of tons`)) %>% mutate(Precision = test) %>%  mutate_if(is.character, as.factor)%>%select(-c(test,id)) %>%  group_by(Dimension) %>%arrange(Dimension,desc(`Loss (in %)`))

# unit_no <- t %>% filter(unit == "Number of fish") %>% filter(Dimension %in% c("species", "source_authority","cat_geo", "fishingfleet")) %>% mutate(Dimension = as.factor(Dimension)) %>%  mutate(test = ifelse(`Loss (in %)` >10,"Others",as.character(Precision))) %>%mutate(Precision = test) %>%    mutate(Perte_pourcent = 100*((value_sum_1 - value_sum_2)/value_sum_1)) %>%  mutate_if(is.character, as.factor)%>%select(-test) %>% ungroup() %>%  group_by(Precision,unit, Dimension)%>% summarise_all(sum)  %>% group_by(unit, Dimension) %>%arrange(desc(`Loss (in %)`), desc(`Loss in millions of tons`)) %>% group_by(Dimension)
# library(kable)
```


```{r paged.print=TRUE}
qflextable(as_grouped_data(unit %>% ungroup(), groups = c("Dimension","unit"))) 
```





<!-- ***In numbers*** -->

<!-- ```{r paged.print=TRUE} -->
<!-- qflextable(as_grouped_data(unit_no, groups = c("Dimension")))  -->
<!-- ``` -->

## Loss in geographical data

```{r}
tmap_mode("view")
inner_join <- inner_join(shapefile.fix,(t %>% filter(Dimension == "geographic_identifier")) , by = c("code"="Precision"))%>% mutate(cat_perte = as.factor(case_when(`Loss (in %)` == 0 ~ 'No loss', `Loss (in %)` == 100~'All data lost', TRUE ~ 'Partial loss')))
# tm_shape(inner_join) +
#   tm_fill("Loss (in %)", palette="RdYlGn", style="cont", n=8,
# 				 id="name", midpoint = 0)+
#   tm_layout(legend.outside = FALSE)+ tm_shape(inner_join %>% filter(cat_perte == 'No loss')) + tm_borders(col="skyblue")+tm_shape(inner_join %>% filter(cat_perte == 'All data lost')) +tm_borders(col="red") +tm_facets(by = c("unit", "cat_geo"),free.coords = FALSE)






tmap::tmap_mode("view")
tm_shape(inner_join(shapefile.fix,(t %>% filter(Dimension == "geographic_identifier")) , by = c("code"="Precision")) %>% mutate(cat_perte = as.factor(case_when(`Loss (in %)` == 0 ~ 'No loss', `Loss (in %)` == 100~'All data lost', TRUE ~ 'Partial loss')))
         # %>% filter(unit == "Tons")
         )+
  tm_fill( "cat_perte", palette="RdYlGn", style="cont", n=8,
				 id="name", midpoint = 0) +
  tm_layout(legend.outside = FALSE) + tm_facets(by = c("unit", "cat_geo"))
```

## Loss in temporal data

Here is represented the loss in percent for each year. 

```{r}

t %>%
 filter(Dimension == "time_start") %>% mutate(Time = as.Date(Precision)) %>% 
 ggplot() +
 aes(x = Time, weight = `Loss (in %)`) +
 geom_bar(fill = "#112446") +
 theme_minimal()+facet_wrap("unit")+labs(y = "Loss in %")

# t %>%
#  filter(Dimension %in% "time_end") %>%
#  ggplot() +
#  aes(x = Precision, weight = `Loss in millions of tons`) +
#  geom_bar(fill = "#112446") +
#  theme_minimal()+facet_wrap("unit")


```


Here we represented for each area the polygons keeping all the initial information, the one losing a part and the one losing all the information.

We'll analyse now, only the lines where there are differences between the data. 

```{r}
setdiff_init_final <- setdiff(init, final)

setdiff_final_init <- setdiff(final, init)


all_different_row <- gdata::combine(setdiff_final_init, setdiff_init_final)
test <- head(all_different_row,15)
```

```{r}
ggplot(all_different_row)+geom_bar(aes(x = source))
```

# The species lost (to help for new analysis)

The data that was in initial table but not in final is: 

```{r}
setdiff_i_a <- setdiff(init, final) %>% select(-value)
```

The data in final dataset but not in initial is: 

```{r}
setdiff_a_i <- setdiff(final, init) %>% select(-value)
```

```{r}
tes <- rbind(setdiff_i_a,setdiff_a_i)
species_filtered <- unique(tes$species)

```

