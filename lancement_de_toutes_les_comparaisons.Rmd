---
title: "lancement de toutes les comparaisons"
author: "Bastien Grasset"
date: "09/02/2022"
output: html_document
params: 
  working_directory: "Les7entites_finies"
  strates_to_check_doublon: ""

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(dplyr)
```

```{r}
fonction_markdown_si_diff = function(init, final,nom_de_sortie1 = init, nom_de_sortie2 = final){
  init2 <- readRDS(init)
  final2 <- readRDS(final)
  if (!(identical(init2, final2))) {
    print(paste0("Le jeux de données initial a un total de ",sum((init2 %>% filter(unit == "t"))$value, na.rm = TRUE), "en nombre et de ",sum((init2 %>% filter(unit == "no"))$value, na.rm = TRUE)," en valeur"))
    if(!(exists(paste0(nom_de_sortie1,nom_de_sortie2,"Markdown.html")))){
    
      rmarkdown::render("comp_sans_shiny.Rmd", params = list(init = init, final = final), output_dir = paste0(nom_de_sortie1,nom_de_sortie2,"Markdown.html"))
      
    }  
        
      
    
  } else {print(paste0("There are no differences between", init, "and", final))}
  
}
```


Ce markdown a pour objectif de lancer toutes les comparaisons entre les données issues du lancement du tunaatlas. 

Les comparaisons sont faites deux à deux entre chaque jeux de données et nous nous intéresserons particulièrement à certaines variables d'intérêts selon les jeux de données utilisés. 

Dans un premier temps nous lançons toutes les comparaisons entre les données initiales et finales de chaque entité. Ensuite nous comparons les données finales entre elles et pour finir nous nous intéresserons pour chaque entité à ce les différents steps ont comme impact. 
Finalement dans un dernier temps et possiblement un autre markdown, nous étudierons au sein de chaque entité certaines pertes pour certains steps. 

# Comparaison des données initiales et finales pour chaque entité

```{r}
library(RMySQL)
fonction_markdown_si_diff_init = function(init, final,nom_de_sortie1 = init, nom_de_sortie2 = final){
  
  if (!(identical(init, final))) {
    
      rmarkdown::render("comp_sans_shiny.Rmd", params = list(init = paste0(i,"/Rds/",first), final = paste0(i,"/Rds/",final)), output_file  = paste0(first,"final",last,"Markdown.html"))
    print(paste0("Nous pouvons retrouver la comparaison détaillée des deux jeux de données sous le chemin d'accès","Markdown/",first,"final",last,"Markdown.html"))
    
  } else {print("There are no differences between")}
  
}

list_dir <- list.dirs(path =paste0("~/Documents/Tunaatlas_level1/data/",params$working_directory, "/entities"), full.names = TRUE, recursive = FALSE)
dir.create(paste0("~/Documents/Tunaatlas_level1/data/",params$working_directory, "/entities","/Markdown"))

#only for this example

list_dir <- list_dir[c(2,5,7)]

for (i in list_dir){

  tmpshot <- fileSnapshot(paste0(i,"/Rds"))
first <- rownames(tmpshot$info[which.min(tmpshot$info$mtime),])
last <- rownames(tmpshot$info[which.max(tmpshot$info$mtime),])
  # fonction_markdown_si_diff(first, last)
fonction_markdown_si_diff_init(first, last)

}




```


# Comparaison des données finales entre elles 

Pour ces comparaisons nous n'allons pas comparer tous les jeux de données entre eux ce qui serait très long et peu utile. Nous nous contenterons d'évaluer la différence entre les principaux et les nominals catchs ainsi que la différence entre les entités particulières et leurs homologues avec une options en plus ou en moins (include WCPFC ou raise billshark)

```{r}

nominal <-  global_catch_1deg_1m_ps_bb_firms_level0
deg1 <-  global_catch_1deg_1m_ps_bb_firms_level0
deg5 <- global_catch_5deg_1m_firms_level0
all <- global_catch_5deg_1m_firms_level0

```

# Analyse des options initiales

## Analyse de l'inclusion ou non de WCPFC sur les données 1 deg

```{r}
fonction_markdown_si_diff("~/Documents/Analyse_des_scripts/Test01_02/lancement/jobs/Les7entites_finies/entities/global_catch_1deg_1m_ps_bb_includeWCPFC_firms_level0/Rds/georef_dataset_level0_step11global_catch_1deg_1m_ps_bb_includeWCPFC_firms_level0.rds","~/Documents/Analyse_des_scripts/Test01_02/lancement/jobs/Les7entites_finies/entities/global_catch_1deg_1m_ps_bb_firms_level0/Rds/georef_dataset_level0_step11global_catch_1deg_1m_ps_bb_firms_level0.rds", "without_wpcpf", "with_wcpfc")

  # rmarkdown::render("comp_sans_shiny.Rmd", params = list(init = "global_catch_1deg_1m_ps_bb_firms_level0/Rds/georef_dataset_level0_step11global_catch_1deg_1m_ps_bb_firms_level0", final ="global_catch_1deg_1m_ps_bb_options_raise_false_firms_level0/Rds/georef_dataset_level0_step11global_catch_1deg_1m_ps_bb_options_raise_false_firms_level0"), output_dir = paste0("comparaison_including_wcpfc",init,"final",final,"Markdown.html"))

```

Nous remarquerons qu'il n'y a pas de différence entre le tuna atlas 1 degré incluant ou non les données de WCPFC.

## Analyse du raising factor sur les données IATTC des requins 1 deg

```{r}
  rmarkdown::render("comp_sans_shiny.Rmd", params = list(init = "global_catch_1deg_1m_ps_bb_firms_level0/Rds/georef_dataset_level0_step11global_catch_1deg_1m_ps_bb_firms_level0", final ="entities/global_catch_1deg_1m_ps_bb_options_raise_false_firms_level0/Rds/georef_dataset_level0_step11global_catch_1deg_1m_ps_bb_options_raise_false_firms_level0.rds"), output_dir = paste0("comparaison_raising_sharks_iattc",init,"comparaison_not_raising_sharks_iattc",final,"Markdown.html"))
```

## Analyse du raising factor sur les données IATTC des requins 5 deg

```{r}
  rmarkdown::render("comp_sans_shiny.Rmd", params = list(init = "global_catch_5deg_1m_ps_bb_firms_level0/Rds/georef_dataset_level0_step11global_catch_5deg_1m_ps_bb_firms_level0", final ="entities/global_catch_5deg_1m_ps_bb_options_raise_false_firms_level0/Rds/georef_dataset_level0_step11global_catch_5deg_1m_ps_bb_options_raise_false_firms_level0.rds"), output_dir = paste0("comparaison_raising_sharks_iattc",init,"comparaison_not_raising_sharks_iattc",final,"Markdown.html"))
```

# Analyse des choix sur les overlapp

Pour l'analyse des choix sur les overlapp nous décidons d'étudier l'impact sur le jeux de données global.

## Valeur maximale par strate pour le 5 degré

```{r}

fonction_markdown_si_diff("global_catch_firms_level0/Rds/georef_dataset_level0_step5global_catch_firms_level0.rds", "global_catch_firms_level0/Rds/georef_dataset_level0_step10global_catch_firms_level0.rds")

strates_to_check_doublon <- if ((is.null(params$strates_to_check_doublon))){c("fishingfleet", "gear", "time_start", "time_end", "geographic_identifier", "schooltype", "species", "catchtype", "unit")} else{ params$strates_to_check_doublon}

georef_dataset_level0_step5global_catch_5deg_1m_firms_level0 <- readRDS("~/Documents/Analyse_des_scripts/Test01_02/lancement/jobs/Les7entites_finies/entities/global_catch_5deg_1m_firms_level0/Rds/georef_dataset_level0_step5global_catch_5deg_1m_firms_level0.rds")
pourcent_strates_identiques <- 100*(nrow(georef_dataset_level0_step5global_catch_5deg_1m_firms_level0) - nrow(georef_dataset_level0_step5global_catch_5deg_1m_firms_level0 %>% select(strates_to_check_doublons) %>% distinct())/nrow(georef_dataset_level0_step5global_catch_5deg_1m_firms_level0))

```

Le choix effectué sur les overlapp est le suivant. Pour chaque combinaison de `r strates_to_check_doublon` on regarde le maximum pour chaque rfmo. 

On remarque que pour `r pourcent_strates_identiques`% des strates il n'y a pas de doublons. Les données sont donc à `r 100 - pourcent_strates_identiques`% conservées.


## Valeur maximale par strate pour le tuna atlas global

```{r}

fonction_markdown_si_diff("global_catch_firms_level0/Rds/georef_dataset_level0_step5global_catch_firms_level0.rds", "global_catch_firms_level0/Rds/georef_dataset_level0_step10global_catch_firms_level0.rds")

```

## Ancienne méthode

Nous prenons ici l'exemple des données totales et pour le premier step géré par un overlapp précédemment (step10) (pour le moment). En effet, anciennement les 3 premiers overlapp, incluant tous CCSBT, étaient gérés sur la base de l'espèce et non pas de la zone. 

### Comparaison ancienne méthode/ nouvelle méthode

```{r}

fonction_markdown_si_diff("global_catch_firms_level0/Rds/georef_dataset_level0_step10global_catch_firms_level0.rds", "global_catch_firms_level0/Rds/georef_dataset_level0_step10global_catch_firms_level0ancient.rds", "newone", "ancien_keeping_ctoi")

```

### Comparaison dans l'ancienne méthode : IOTC/WCPFC

```{r}
#careful has to verify that it is really the first one ctoi and the second one Wcpfc

fonction_markdown_si_diff("global_catch_firms_level0/Rds/georef_dataset_level0_step10global_catch_firms_level0ancient.rds", "global_catch_firms_level0/Rds/georef_dataset_level0_step10global_catch_firms_level0reverse.rds", "ancien_keeping_ctoi", "ancien_keeping_wcpfc")
```

### Comparaison ORGP/CCSBT

#### Comparaison IOTC/CCSBT 

```{r}
fonction_markdown_si_diff("global_catch_firms_level0/Rds/georef_dataset_level0_step9global_catch_firms_level0ancient.rds", "global_catch_firms_level0/Rds/georef_dataset_level0_step9global_catch_firms_level0reverse.rds", "iotc_ccbst", "ancien_iotc_ccbst")
```


#### Comparaison ICCAT/CCSBT 

```{r}
fonction_markdown_si_diff("global_catch_firms_level0/Rds/georef_dataset_level0_step8global_catch_firms_level0ancient.rds", "global_catch_firms_level0/Rds/georef_dataset_level0_step8global_catch_firms_level0reverse.rds", "iccat_ccsbt", "ancien_iccat_ccsbt")
```


#### Comparaison WCPFC/CCSBT 

```{r}
fonction_markdown_si_diff("global_catch_firms_level0/Rds/georef_dataset_level0_step7global_catch_firms_level0ancient.rds", "global_catch_firms_level0/Rds/georef_dataset_level0_step7global_catch_firms_level0reverse.rds", "ancien_wcpfc_ccsbt", "ancien_wcpfc_ccsbt")
```



## Analyse du niveau 1

### Analyse de l'ancien niveau 1 sans prise en compte des doublons d'unités

#### Pour les 5 degrés

```{r}
fonction_markdown_si_diff("~/Documents/Analyse_des_scripts/Test01_02/lancement/jobs/Les7entites_finies/entities/5deg_level1_reallocate/georef_dataset_step5.rds", "~/Documents/Analyse_des_scripts/Test01_02/lancement/jobs/Les7entites_finies/entities/global_catch_5deg_1m_firms_level0/Rds/georef_dataset_level0_step11global_catch_5deg_1m_firms_level0.rds", "level1_5deg", "level0_5deg")
```

#### Pour les 1 degré 

```{r}
fonction_markdown_si_diff("~/Documents/Analyse_des_scripts/Test01_02/lancement/jobs/Les7entites_finies/entities/1deg_level1_reallocate/georef_dataset_step5.rds", "~/Documents/Analyse_des_scripts/Test01_02/lancement/jobs/Les7entites_finies/entities/global_catch_1deg_1m_firms_level0/Rds/georef_dataset_level0_step11global_catch_1deg_1m_firms_level0.rds", "level1_1deg", "level0_1deg")
```

#### Pour le global 

```{r}

```

